<!DOCTYPE html>
<html lang="he" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>קופת צדקה דיגיטלית</title>
	
	<link rel="icon" type="image/png" href="icon.jpeg">
	
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Assistant:wght@300;400;700;800&display=swap" rel="stylesheet">
	<link rel="icon" type="image/jpeg" href="icon.jpeg">
	<link rel="apple-touch-icon" href="icon.jpeg">
	<meta name="mobile-web-app-capable" content="yes">
	<meta name="apple-mobile-web-app-capable" content="yes">
	<meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
	<meta name="apple-mobile-web-app-title" content="קופת צדקה">
	<link rel="manifest" href="manifest.json">
    <style>
        body {
            font-family: 'Assistant', sans-serif;
            background-color: #f8fafc;
            margin: 0;
            overflow: hidden;
            display: flex;
            flex-direction: column;
            align-items: center;
            touch-action: none;
        }

        .wheel-container {
            position: relative;
            width: 100%;
            height: 240px;
            perspective: 1200px;
            margin-top: 20px;
            display: flex;
            justify-content: center;
            align-items: center;
        }

        .coin-item {
            position: absolute;
            width: 100px;
            height: 100px;
            transition: transform 0.3s cubic-bezier(0.25, 0.1, 0.25, 1), opacity 0.3s;
            cursor: grab;
            display: flex;
            flex-direction: column;
            align-items: center;
            user-select: none;
            touch-action: none;
        }

        .coin-item img {
            width: 85px;
            height: 85px;
            object-fit: contain;
            filter: drop-shadow(0 4px 8px rgba(0,0,0,0.15));
            pointer-events: none;
        }
		
        .box-wrapper {
            position: relative;
            display: inline-block;
            margin-top: 40px;
			width: 350px;               /* זה הגודל המומלץ לקופה ליד הכותרת */
			height: auto;              /* שומר על הפרופורציות של הקופה */
			display: block;            /* מאפשר מרכוז */
			margin: 0 auto 10px auto;  /* ממרכז את הקופה ומוסיף רווח קטן מתחתיה */
			filter: drop-shadow(0px 4px 6px rgba(0,0,0,0.1)); /* מוסיף צל עדין לצורה של הקופה */
        }

        .tzedaka-label {
            position: absolute;
            top: 55%;
            left: 50%;
            transform: translate(-50%, -50%);
            font-size: 3.0rem;
            font-weight: 900;
            color: #3e2723;
            text-shadow: 1px 1px 2px rgba(255,255,255,0.5);
            pointer-events: none;
            z-index: 20;
        }

        @keyframes coin-fall {
            0% { transform: scale(1.2) translateY(0); opacity: 1; }
            100% { transform: scale(1.2) translateY(300px); opacity: 0; }
        }
        .anim-fall { animation: coin-fall 0.4s ease-in forwards; }

        .modal {
            display: none;
            position: fixed;
            z-index: 1000;
            inset: 0;
            background: rgba(15, 23, 42, 0.6);
            backdrop-filter: blur(8px);
            align-items: center;
            justify-content: center;
        }

        input::-webkit-outer-spin-button,
        input::-webkit-inner-spin-button { -webkit-appearance: none; margin: 0; }
    </style>
</head>
<body class="min-h-screen">

    <header class="w-full max-w-4xl flex justify-between items-center p-6">
        <div class="flex flex-col">
            <h1 class="text-3xl font-black text-slate-900">קופת צדקה</h1>
            <span class="text-blue-600 font-bold text-sm h-5">גרור את המטבע</span>
        </div>
        
        <button onclick="toggleModal(true)" class="action-btn bg-white p-4 rounded-full shadow-lg border border-slate-100 text-blue-600">
            <svg xmlns="http://www.w3.org/2000/svg" class="h-8 w-8" fill="none" viewBox="0 0 24 24" stroke="currentColor">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 16h-1v-4h-1m1-4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z" />
            </svg>
        </button>
    </header>

    <div class="wheel-container" id="wheel"></div>

    <div class="box-wrapper" id="drop-target">
        <div id="box-ui" class="relative transition-transform duration-300">
            <img src="img/box.png">
            <div class="tzedaka-label">צדקה</div>
        </div>
    </div>

    <div id="statusModal" class="modal" onclick="toggleModal(false)">
        <div class="bg-white p-8 rounded-[2.5rem] text-center max-w-sm w-[90%] shadow-2xl" onclick="event.stopPropagation()">
            <h3 class="text-slate-400 font-bold text-xs uppercase tracking-widest mb-2">יתרה נוכחית</h3>
            <div id="total-display" class="text-5xl font-black text-slate-900 mb-8 tabular-nums">₪0.00</div>
            
            <div id="main-actions" class="space-y-3">
                <div class="grid grid-cols-2 gap-3">
                    <button onclick="resetFull()" class="bg-red-50 text-red-600 font-bold py-3 rounded-2xl active:scale-95 transition-all">ריקון מלא</button>
                    <button onclick="showPartialInput()" class="bg-blue-50 text-blue-600 font-bold py-3 rounded-2xl active:scale-95 transition-all">ריקון חלקי</button>
                </div>
            </div>
            
            <div id="partial-ui" class="hidden mt-4 pt-4 border-t border-slate-100">
                <input type="number" id="withdraw-amount" placeholder="כמה להוציא?" class="w-full text-center text-xl font-bold p-3 bg-slate-50 rounded-xl border-none focus:ring-2 focus:ring-blue-500 mb-3">
                <div class="flex gap-2">
                    <button onclick="resetPartial()" class="flex-1 bg-blue-600 text-white font-bold py-3 rounded-xl shadow-md">אשר</button>
                    <button onclick="hidePartialInput()" class="bg-slate-100 text-slate-500 px-4 rounded-xl">ביטול</button>
                </div>
            </div>

        </div>
    </div>

    <script>
        // המטבעות שלך (הדבק את ה-Base64 המלא)
        const COIN_DATA = [
            { name: '10 אגורות', val: 0.1, src: 'img/10ag.png' },
            { name: 'חצי שקל', val: 0.5, src: 'img/half.png' },
            { name: '1 שקל', val: 1.0, src: 'img/1nis.png' },
            { name: '2 שקלים', val: 2.0, src: 'img/2nis.png' },
            { name: '5 שקלים', val: 5.0, src: 'img/5nis.png' },
            { name: '10 שקלים', val: 10.0, src: 'img/10nis.png' }
        ];

        let total = parseFloat(localStorage.getItem('charity_v8_total')) || 0;
        let rotation = parseFloat(localStorage.getItem('wheel_rotation')) || 0;
        let activeIdx = 0;
        
        let isDragging = false;
        let dragMode = null; // 'wheel' או 'coin'
        let dragCoinElem = null;
        let startX, startY;

        const wheel = document.getElementById('wheel');
        const dropTarget = document.getElementById('drop-target');

        function initWheel() {
            COIN_DATA.forEach((coin, i) => {
                const div = document.createElement('div');
                div.className = 'coin-item';
                div.dataset.index = i;
                div.innerHTML = `<img src="${coin.src}">`;
                wheel.appendChild(div);
            });
            updateWheel();
        }

        function updateWheel() {
            const items = document.querySelectorAll('.coin-item');
            const step = (Math.PI * 2) / items.length;
            items.forEach((item, i) => {
                if (dragMode === 'coin' && item === dragCoinElem) return;
                const angle = i * step + rotation;
                const x = Math.sin(angle) * 150; 
                const z = Math.cos(angle) * 100;
                const scale = (z + 200) / 250;
                const opacity = (z + 100) / 200;
                item.style.transform = `translateX(${x}px) translateZ(${z}px) scale(${scale})`;
                item.style.zIndex = Math.round(z + 100);
                item.style.opacity = Math.max(0.3, opacity);
                if (z > 98) { 
                    activeIdx = i;
                }
            });
            localStorage.setItem('wheel_rotation', rotation);
        }

        function onStart(e) {
            const clientX = e.touches ? e.touches[0].clientX : e.clientX;
            const clientY = e.touches ? e.touches[0].clientY : e.clientY;
            isDragging = true;
            startX = clientX;
            startY = clientY;
            dragMode = null; // נחליט על המוד ב-Move

            const target = e.target.closest('.coin-item');
            if (target && parseInt(target.dataset.index) === activeIdx) {
                dragCoinElem = target;
            } else {
                dragCoinElem = null;
            }
            
            document.querySelectorAll('.coin-item').forEach(el => el.style.transition = 'none');
        }

        function onMove(e) {
            if (!isDragging) return;
            const clientX = e.touches ? e.touches[0].clientX : e.clientX;
            const clientY = e.touches ? e.touches[0].clientY : e.clientY;
            const dx = clientX - startX;
            const dy = clientY - startY;

            // החלטה על סוג התנועה (רק בפעם הראשונה שזזים)
            if (!dragMode) {
                if (Math.abs(dy) > Math.abs(dx) && dragCoinElem && dy > 10) {
                    dragMode = 'coin'; // תנועה אנכית למטה - גרירת מטבע
                } else if (Math.abs(dx) > 5) {
                    dragMode = 'wheel'; // תנועה אופקית - סיבוב גלגל
                }
                return;
            }

            if (dragMode === 'wheel') {
                rotation += dx * 0.008;
                startX = clientX;
                updateWheel();
            } else if (dragMode === 'coin' && dragCoinElem) {
                dragCoinElem.style.transform = `translate(${dx}px, ${dy}px) scale(1.2)`;
                dragCoinElem.style.zIndex = "500";
            }
        }

        function onEnd() {
            if (!isDragging) return;
            isDragging = false;

            if (dragMode === 'wheel') {
                document.querySelectorAll('.coin-item').forEach(el => el.style.transition = 'transform 0.5s cubic-bezier(0.175, 0.885, 0.32, 1.275), opacity 0.5s');
                snapToClosest();
            } else if (dragMode === 'coin' && dragCoinElem) {
                const rect = dropTarget.getBoundingClientRect();
                const coinRect = dragCoinElem.getBoundingClientRect();
                const isOver = (coinRect.left < rect.right && coinRect.right > rect.left && coinRect.top < rect.bottom && coinRect.bottom > rect.top);

                if (isOver) {
                    executeDonation();
                } else {
                    dragCoinElem.style.transition = 'transform 0.3s ease-out';
                    updateWheel();
                }
            }
            dragMode = null;
        }

        function executeDonation() {
            const coin = COIN_DATA[activeIdx];
            total += coin.val;
            save();
            
            const elem = document.querySelector(`.coin-item[data-index="${activeIdx}"]`);
            elem.classList.add('anim-fall');
            document.getElementById('box-ui').style.transform = 'scale(0.92)';

            setTimeout(() => {
                elem.classList.remove('anim-fall');
                document.getElementById('box-ui').style.transform = 'scale(1)';
                updateWheel();
            }, 400);
        }

        function snapToClosest() {
            const step = (Math.PI * 2) / COIN_DATA.length;
            const closestIdx = Math.round(-rotation / step) % COIN_DATA.length;
            rotation = -((closestIdx + COIN_DATA.length) % COIN_DATA.length) * step;
            updateWheel();
        }

        // ניהול מודאל
        function toggleModal(show) {
            document.getElementById('total-display').innerText = `₪${total.toFixed(2)}`;
            document.getElementById('statusModal').style.display = show ? 'flex' : 'none';
            hidePartialInput();
        }

        function resetFull() {
            if (confirm("האם לרוקן את כל הקופה?")) {
                total = 0;
                save();
                document.getElementById('total-display').innerText = `₪0.00`;
				
				// ✅ ממשיך לתשלום בביט לפי כל היתרה
				payWithBit(amountToPay);
            }
        }

        function showPartialInput() {
            document.getElementById('partial-ui').classList.remove('hidden');
        }

        function hidePartialInput() {
            document.getElementById('partial-ui').classList.add('hidden');
            document.getElementById('withdraw-amount').value = '';
        }

        function resetPartial() {
            const amount = parseFloat(document.getElementById('withdraw-amount').value);
            if (!isNaN(amount) && amount > 0 && amount <= total) {
                total -= amount;
                save();
                document.getElementById('total-display').innerText = `₪${total.toFixed(2)}`;
                hidePartialInput();
				
				// ✅ ממשיך לתשלום בביט לפי הסכום שנבחר
				payWithBit(amount);
            } else {
                alert("סכום לא תקין");
            }
        }

        function save() { localStorage.setItem('charity_v8_total', total); }

        window.addEventListener('mousedown', onStart);
        window.addEventListener('mousemove', onMove);
        window.addEventListener('mouseup', onEnd);
        window.addEventListener('touchstart', onStart);
        window.addEventListener('touchmove', onMove);
        window.addEventListener('touchend', onEnd);

        initWheel();
		
		function payWithBit(amount) {
			// הגנה
			if (!amount || amount <= 0) return;

			// כאן אפשר לשנות מה שרוצים
			const note = `צדקה בסך ₪${amount.toFixed(2)}`;

			// Bit עובד הכי טוב דרך deeplink (על מובייל)
			// אם יש לך מספר/יעד קבוע - תוכל להכניס אותו כאן
			// יש גרסאות שונות ללינקים של Bit, אז זה פורמט נפוץ:
			const bitUrl = `https://bitpay.co.il/app/pay?amount=${encodeURIComponent(amount.toFixed(2))}&comment=${encodeURIComponent(note)}`;

			window.open(bitUrl, "_blank");
		}
    </script>
</body>
</html>